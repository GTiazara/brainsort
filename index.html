<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BrainSort</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#2563eb" />
  <link rel="apple-touch-icon" href="icons/icon-192x192.png">
  <script>
    if ("serviceWorker" in navigator) {
        window.addEventListener("load", () => {
        navigator.serviceWorker.register("service-worker.js")
            .then(() => console.log("‚úÖ Service Worker registered"))
            .catch(err => console.log("Service Worker failed:", err));
        });
    }
  </script>
</head>
<body id="body"
    class="min-h-screen flex flex-col items-center bg-gray-50 text-gray-800 p-4 sm:p-6 transition-colors duration-500">

<h1 class="text-3xl sm:text-4xl font-bold text-blue-600 mt-4 mb-2 text-center">üß† BrainSort</h1>
<p class="text-center text-sm sm:text-base mb-4">
  Clique sur les nombres <strong>dans l‚Äôordre ascendant</strong> le plus vite possible !
</p>

<!-- Settings Panel -->
<div id="settings" class="w-full max-w-md bg-white p-4 sm:p-6 rounded-xl shadow-md space-y-6 transition-colors duration-500">

  <!-- Number of Elements -->
  <div>
    <h3 class="font-semibold mb-2 text-sm sm:text-base">Nombre d‚Äô√©l√©ments</h3>
    <div class="flex flex-wrap gap-2">
      <button class="option-btn flex-1 min-w-[60px] py-2 rounded bg-gray-200 text-sm sm:text-base">5</button>
      <button class="option-btn flex-1 min-w-[60px] py-2 rounded bg-gray-200 text-sm sm:text-base">7</button>
      <button class="option-btn flex-1 min-w-[60px] py-2 rounded bg-gray-200 text-sm sm:text-base">10</button>
      <button class="option-btn flex-1 min-w-[60px] py-2 rounded bg-gray-200 text-sm sm:text-base">üé≤ Random</button>
    </div>
  </div>

  <!-- Difficulty -->
  <div>
    <h3 class="font-semibold mb-2 text-sm sm:text-base">Difficult√©</h3>
    <div class="flex flex-wrap gap-2">
      <button class="difficulty-btn flex-1 min-w-[60px] py-2 bg-green-200 text-green-800 rounded text-sm sm:text-base">Facile</button>
      <button class="difficulty-btn flex-1 min-w-[60px] py-2 bg-yellow-200 text-yellow-800 rounded text-sm sm:text-base">Moyen</button>
      <button class="difficulty-btn flex-1 min-w-[60px] py-2 bg-red-200 text-red-800 rounded text-sm sm:text-base">Difficile</button>
    </div>
  </div>

  <!-- Ascending / Descending Toggle -->
  <div class="flex items-center justify-between">
    <span class="text-sm sm:text-base font-semibold">Ordre</span>
    <label class="relative inline-flex items-center cursor-pointer">
      <input type="checkbox" id="orderToggle" class="sr-only peer" checked>
      <div class="w-14 h-7 bg-gray-300 rounded-full peer-checked:bg-blue-500 transition-all duration-300"></div>
      <div class="absolute left-0.5 top-0.5 w-6 h-6 bg-white rounded-full shadow-md transition-all duration-300 peer-checked:translate-x-7"></div>
    </label>
    <span class="ml-2 text-sm sm:text-base" id="orderLabel">Ascendant</span>
  </div>

  <!-- Theme -->
  <div>
    <h3 class="font-semibold mb-2 text-sm sm:text-base">Th√®me / Couleur</h3>
    <div class="flex flex-wrap gap-2">
      <div class="theme-card flex-1 min-w-[80px] bg-gray-50 text-gray-800 p-3 rounded-lg cursor-pointer text-center text-sm sm:text-base">Light</div>
      <div class="theme-card flex-1 min-w-[80px] bg-gray-900 text-gray-100 p-3 rounded-lg cursor-pointer text-center text-sm sm:text-base">Dark</div>
      <div class="theme-card flex-1 min-w-[80px] bg-gradient-to-r from-purple-400 via-pink-400 to-red-400 text-white p-3 rounded-lg cursor-pointer text-center text-sm sm:text-base">Random</div>
    </div>
  </div>

  <!-- Challenge Mode Toggle -->
  <div class="flex items-center justify-between">
    <span class="text-sm sm:text-base font-semibold">Mode Challenge</span>
    <label class="relative inline-flex items-center cursor-pointer">
      <input type="checkbox" id="challengeMode" class="sr-only peer">
      <div class="w-14 h-7 bg-gray-300 rounded-full peer-checked:bg-red-500 transition-all duration-300"></div>
      <div class="absolute left-0.5 top-0.5 w-6 h-6 bg-white rounded-full shadow-md transition-all duration-300 peer-checked:translate-x-7"></div>
    </label>
  </div>

  <div id="challengeTimeContainer" class="mt-2 hidden">
    <label class="block font-semibold mb-1 text-sm sm:text-base">Temps limite (secondes):</label>
    <input type="number" id="challengeTime" class="w-full border-gray-300 rounded-md p-2 text-sm sm:text-base" value="30" min="5" max="120" />
  </div>

  <!-- Live Timer Toggle -->
  <div class="flex items-center justify-between">
    <span class="text-sm sm:text-base font-semibold">Afficher Timer</span>
    <label class="relative inline-flex items-center cursor-pointer">
      <input type="checkbox" id="showTime" class="sr-only peer" checked>
      <div class="w-14 h-7 bg-gray-300 rounded-full peer-checked:bg-green-500 transition-all duration-300"></div>
      <div class="absolute left-0.5 top-0.5 w-6 h-6 bg-white rounded-full shadow-md transition-all duration-300 peer-checked:translate-x-7"></div>
    </label>
  </div>

  <!-- Sound Toggle -->
  <div class="flex items-center justify-between">
    <span class="text-sm sm:text-base font-semibold">Sons activ√©s</span>
    <label class="relative inline-flex items-center cursor-pointer">
      <input type="checkbox" id="soundToggle" class="sr-only peer" checked>
      <div class="w-14 h-7 bg-gray-300 rounded-full peer-checked:bg-indigo-500 transition-all duration-300"></div>
      <div class="absolute left-0.5 top-0.5 w-6 h-6 bg-white rounded-full shadow-md transition-all duration-300 peer-checked:translate-x-7"></div>
    </label>
  </div>

  <button id="start-btn" class="w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg text-sm sm:text-base transition">
    D√©marrer le jeu
  </button>
</div>

<!-- Timer -->
<div id="timer-container" class="hidden mb-4">
  <span class="text-lg font-semibold">‚è± Temps : </span>
  <span id="timer" class="text-2xl font-bold text-blue-600">0.00 s</span>
</div>

<!-- Game Area -->
<div id="numbers" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-3 w-full max-w-md mt-2"></div>

<!-- Message -->
<div id="message" class="text-center text-xl mt-6 font-medium"></div>

<!-- Result Card -->
<div id="result-card" class="hidden mt-6 bg-white shadow-lg rounded-xl p-6 text-center space-y-4 transition-colors duration-500">
  <div class="text-2xl font-bold text-green-600">‚úÖ Bravo !</div>
  <div id="final-time" class="text-3xl font-extrabold text-blue-600">0.00 s</div>
  <div id="score-display" class="text-xl font-semibold text-purple-600"></div>
  <div class="flex flex-wrap justify-center gap-4 mt-4">
    <button id="retry-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg text-sm sm:text-base">üîÅ Rejouer</button>
    <button id="back-btn" class="bg-gray-400 hover:bg-gray-500 text-white font-semibold py-2 px-4 rounded-lg text-sm sm:text-base">‚öôÔ∏è Param√®tres</button>
  </div>
</div>

<!-- Leaderboard -->
<div id="leaderboard" class="hidden mt-6 w-full max-w-md bg-white shadow-lg rounded-xl p-4 text-center">
  <h2 class="text-xl font-bold mb-2">üèÜ Hall of Fame</h2>
  <ol id="leaderboard-list" class="list-decimal space-y-1"></ol>
</div>

<!-- Achievements -->
<div id="achievements" class="hidden mt-4 w-full max-w-md bg-gray-100 shadow-md rounded-xl p-4 text-center">
  <h2 class="text-lg font-semibold mb-2">üéñ Achievements</h2>
  <ul id="achievements-list" class="list-disc space-y-1"></ul>
</div>

<!-- Sounds -->
<audio id="click-sound" src="sounds/click.wav" preload="auto"></audio>
<audio id="success-sound" src="sounds/success.wav"></audio>
<audio id="fail-sound" src="sounds/fail.wav"></audio>

<script>
/* ---------- Refs ---------- */
const numbersContainer = document.getElementById("numbers");
const message = document.getElementById("message");
const startBtn = document.getElementById("start-btn");
const retryBtn = document.getElementById("retry-btn");
const backBtn = document.getElementById("back-btn");
const timerEl = document.getElementById("timer");
const timerBox = document.getElementById("timer-container");
const resultCard = document.getElementById("result-card");
const finalTimeEl = document.getElementById("final-time");
const scoreDisplay = document.getElementById("score-display");
const body = document.getElementById("body");
const settings = document.getElementById("settings");
const instruction = document.querySelector("p");
const orderToggle = document.getElementById("orderToggle");
const orderLabel = document.getElementById("orderLabel");
const clickSound = document.getElementById("click-sound");
const successSound = document.getElementById("success-sound");
const failSound = document.getElementById("fail-sound");
const soundToggle = document.getElementById("soundToggle");
const challengeCheckbox = document.getElementById("challengeMode");
const challengeTimeContainer = document.getElementById("challengeTimeContainer");

/* ---------- State ---------- */
let selectedNum = "random";
let selectedDiff = 100;
let selectedTheme = "light";
let ascendingOrder = true;
let isChallenge = false;
let remainingTime = 0;
let soundEnabled = true;
let numbers = [], sorted = [], expected = 0, timerInterval = null, startTime = null;

/* ---------- Sound toggle ---------- */
soundToggle.addEventListener("change", () => { soundEnabled = soundToggle.checked; });

/* ---------- UI: option buttons ---------- */
document.querySelectorAll(".option-btn").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    document.querySelectorAll(".option-btn").forEach(b=>b.classList.remove("ring-2","ring-blue-500"));
    btn.classList.add("ring-2","ring-blue-500");
    selectedNum = btn.textContent.trim()==="üé≤ Random" ? "random" : btn.textContent.trim();
  });
});

document.querySelectorAll(".difficulty-btn").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    document.querySelectorAll(".difficulty-btn").forEach(b=>b.classList.remove("ring-2","ring-blue-500"));
    btn.classList.add("ring-2","ring-blue-500");
    selectedDiff = btn.textContent.trim()==="Facile" ? 50 : btn.textContent.trim()==="Moyen" ? 100 : 999;
  });
});

document.querySelectorAll(".theme-card").forEach(card=>{
  card.addEventListener("click", ()=>{
    document.querySelectorAll(".theme-card").forEach(c=>c.classList.remove("ring-4","ring-blue-500"));
    card.classList.add("ring-4","ring-blue-500");
    selectedTheme = card.textContent.trim().toLowerCase();
    applyTheme(selectedTheme);
  });
});

/* ---------- Challenge toggle ---------- */
challengeCheckbox.addEventListener("change", ()=> {
  challengeTimeContainer.style.display = challengeCheckbox.checked ? "block" : "none";
});

/* ---------- Order toggle ---------- */
orderToggle.addEventListener("change", ()=>{
  ascendingOrder = orderToggle.checked;
  orderLabel.textContent = ascendingOrder ? "Ascendant" : "Descendant";
  instruction.innerHTML = `Clique sur les nombres <strong>dans l‚Äôordre ${ascendingOrder ? "ascendant" : "descendant"}</strong> le plus vite possible !`;
});

/* ---------- Start/retry/back ---------- */
startBtn.addEventListener("click", startGame);
retryBtn.addEventListener("click", startGame);
backBtn.addEventListener("click", ()=>{ resultCard.classList.add("hidden"); settings.style.display="block"; });

/* ---------- Game logic ---------- */
function startGame(){
  message.textContent = "";
  numbersContainer.innerHTML = "";
  expected = 0;
  clearInterval(timerInterval); timerInterval = null; startTime = null;
  resultCard.classList.add("hidden");
  settings.style.display = "none";
  applyTheme(selectedTheme);

  ascendingOrder = orderToggle.checked;
  isChallenge = challengeCheckbox.checked;
  remainingTime = isChallenge ? parseInt(document.getElementById("challengeTime").value || "30") : 0;
  const showTime = isChallenge || document.getElementById("showTime").checked;
  timerBox.classList.toggle("hidden", !showTime);

  let count = (selectedNum==="random") ? 7 + Math.floor(Math.random()*4) : parseInt(selectedNum) || 7;
  numbers = Array.from({length: count}, ()=> Math.floor(Math.random()*selectedDiff)+1);
  sorted = [...numbers].sort((a,b)=>a-b);
  if(!ascendingOrder) sorted.reverse();
  numbers.sort(()=>Math.random()-0.5);

  numbersContainer.style.gridTemplateColumns = "repeat(auto-fit, minmax(60px,1fr))";
  numbers.forEach(num=>{
    const btn = document.createElement("button");
    btn.textContent = num;
    btn.className = "number w-full text-center bg-white border-2 border-blue-500 text-blue-600 rounded-xl py-4 text-2xl font-bold transition active:scale-95 hover:bg-blue-500 hover:text-white shadow-sm";
    btn.addEventListener("click", ()=> checkNumber(btn, num));
    numbersContainer.appendChild(btn);
  });

  if(showTime){
    if(isChallenge) startChallengeTimer();
    else { startTime = Date.now(); timerInterval = setInterval(updateTimer,100); }
  }
}

function checkNumber(btn,num){
  if (soundEnabled) { clickSound.currentTime = 0; clickSound.play().catch(()=>{}); }
  if(num === sorted[expected]){
    expected++;
    btn.classList.add("invisible");
    if(expected === sorted.length){
      clearInterval(timerInterval); timerInterval = null;
      if (soundEnabled) successSound.play().catch(()=>{});
      const time = isChallenge ? (parseFloat(document.getElementById("challengeTime").value)-remainingTime).toFixed(2) : ((Date.now()-startTime)/1000).toFixed(2);
      showResult(time);
    }
  } else {
    clearInterval(timerInterval); timerInterval = null;
    if (soundEnabled) failSound.play().catch(()=>{});
    message.innerHTML = '<span class="text-red-600">‚ùå Mauvais ordre ! Red√©marrage...</span>';
    setTimeout(startGame,1200);
  }
}

function showResult(time){
  timerBox.classList.add("hidden");
  numbersContainer.innerHTML = "";
  message.textContent = "";
  const timeSeconds = parseFloat(time);
  finalTimeEl.textContent = `${timeSeconds} s`;

  // calculate score
  const score = calculateScore(timeSeconds, numbers.length, selectedDiff);
  scoreDisplay.textContent = `Score: ${score}`;

  // save & achievements
  saveScore({name:"Player", score, time:timeSeconds, elements:numbers.length, difficulty:selectedDiff, date: new Date()});
  updateAchievements(timeSeconds, selectedDiff);

  resultCard.classList.remove("hidden");

  // show leaderboard & achievements
  showLeaderboard();
  showAchievements();
}

function failGame(){
  if (soundEnabled) failSound.play().catch(()=>{});
  message.innerHTML = '<span class="text-red-600 font-bold">‚è∞ Temps √©coul√© ! Vous avez perdu.</span>';
  numbersContainer.innerHTML = "";
}

/* ---------- Timer helpers ---------- */
function startChallengeTimer(){
  timerEl.textContent = `${remainingTime.toFixed(2)} s`;
  timerInterval = setInterval(()=>{
    remainingTime -= 0.1;
    if(remainingTime <= 0){ remainingTime = 0; clearInterval(timerInterval); failGame(); }
    timerEl.textContent = `${remainingTime.toFixed(2)} s`;
  },100);
}

function updateTimer(){
  if(!startTime) return;
  const elapsed = ((Date.now()-startTime)/1000).toFixed(2);
  timerEl.textContent = `${elapsed} s`;
}

/* ---------- Score & Leaderboard ---------- */
function calculateScore(timeSeconds, numElements, difficulty) {
  let diffMultiplier = difficulty === 50 ? 1 : difficulty === 100 ? 2 : 3;
  let elementMultiplier = 1 + (numElements - 5) / 5;
  let speedMultiplier = 10 / timeSeconds;
  return Math.round(100 * diffMultiplier * elementMultiplier * speedMultiplier);
}

function saveScore(scoreObj) {
  let leaderboard = JSON.parse(localStorage.getItem("brainSortLeaderboard") || "[]");
  leaderboard.push(scoreObj);
  leaderboard.sort((a,b)=>b.score - a.score);
  leaderboard = leaderboard.slice(0,10);
  localStorage.setItem("brainSortLeaderboard", JSON.stringify(leaderboard));
}

function getLeaderboard() {
  return JSON.parse(localStorage.getItem("brainSortLeaderboard") || "[]");
}

function updateAchievements(time, difficulty) {
  let ach = JSON.parse(localStorage.getItem("brainSortAchievements") || "{}");
  if(!ach.firstPerfect) ach.firstPerfect = true;
  ach.fiveUnder10 = ach.fiveUnder10 ? ach.fiveUnder10 + (time <= 10 ? 1 : 0) : (time <= 10 ? 1 : 0);
  if(difficulty === 999) ach.maxDifficulty = true;
  localStorage.setItem("brainSortAchievements", JSON.stringify(ach));
}

function showLeaderboard() {
  const leaderboard = getLeaderboard();
  const list = document.getElementById("leaderboard-list");
  list.innerHTML = "";
  leaderboard.forEach((entry)=>{
    const li = document.createElement("li");
    li.textContent = `${entry.name} - ${entry.score} pts (${entry.time}s, ${entry.elements} √©l√©ments, ${entry.difficulty === 50 ? "Facile" : entry.difficulty === 100 ? "Moyen" : "Difficile"})`;
    list.appendChild(li);
  });
  document.getElementById("leaderboard").classList.remove("hidden");
}

function showAchievements() {
  const ach = JSON.parse(localStorage.getItem("brainSortAchievements") || "{}");
  const list = document.getElementById("achievements-list");
  list.innerHTML = "";
  if(ach.firstPerfect) list.innerHTML += "<li>üèÖ First perfect round</li>";
  if(ach.fiveUnder10 >= 5) list.innerHTML += "<li>‚è± 5 rounds under 10s</li>";
  if(ach.maxDifficulty) list.innerHTML += "<li>üî• Max difficulty completed</li>";
  document.getElementById("achievements").classList.remove("hidden");
}

/* ---------- Theme handling ---------- */
function applyTheme(mode){
  const panels = document.querySelectorAll("#settings, #challengeTimeContainer, #result-card, #leaderboard, #achievements");
  body.style.backgroundImage = "";
  panels.forEach(p => { p.style.backgroundImage = ""; });
  if(mode === "light"){
    body.style.backgroundColor = "#f9fafb"; body.style.color = "#1f2937";
    panels.forEach(p => { p.style.backgroundColor = "#ffffff"; p.style.color = "#1f2937"; });
  } else if(mode === "dark"){
    body.style.backgroundColor = "#0f172a"; body.style.color = "#f8fafc";
    panels.forEach(p => { p.style.backgroundColor = "#111827"; p.style.color = "#f8fafc"; });
  } else {
    const r = Math.floor(Math.random()*200) + 20;
    const g = Math.floor(Math.random()*200) + 20;
    const b = Math.floor(Math.random()*200) + 20;
    const bg = `rgb(${r},${g},${b})`;
    const brightness = (r*299 + g*587 + b*114)/1000;
    const textColor = brightness > 128 ? "black" : "white";
    body.style.backgroundColor = bg;
    body.style.color = textColor;
    panels.forEach(p=>{ p.style.backgroundColor = `rgba(${r},${g},${b},0.12)`; p.style.color = textColor; });
  }
}

/* ---------- Init ---------- */
document.querySelectorAll(".option-btn").forEach(b=>{ if(b.textContent.trim() === "7"){ b.classList.add("ring-2","ring-blue-500"); selectedNum = "7"; }});
document.querySelectorAll(".difficulty-btn").forEach(b=>{ if(b.textContent.trim() === "Facile"){ b.classList.add("ring-2","ring-blue-500"); selectedDiff = 50; }});
document.querySelectorAll(".theme-card").forEach(c=>{ if(c.textContent.trim().toLowerCase() === "light"){ c.classList.add("ring-4","ring-blue-500"); selectedTheme = "light"; }});
applyTheme(selectedTheme);
</script>
</body>
</html>
