<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NeuroTri</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="shared.js"></script>

  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#2563eb" />
  <link rel="apple-touch-icon" href="icons/icon-192x192.png">
  <script>
    if ("serviceWorker" in navigator) {
        window.addEventListener("load", () => {
        navigator.serviceWorker.register("service-worker.js")
            .then(() => console.log("‚úÖ Service Worker registered"))
            .catch(err => console.log("Service Worker failed:", err));
        });
    }
  </script>
</head>
<body id="body"
    class="min-h-screen flex flex-col items-center bg-gray-50 text-gray-800 p-4 sm:p-6 transition-colors duration-500">

<h1 class="text-3xl sm:text-4xl font-bold text-blue-600 mt-4 mb-2 text-center">üß† NeuroTri</h1>
<p class="text-center text-sm sm:text-base mb-4">
  Clique sur les nombres <strong>dans l‚Äôordre ascendant</strong> le plus vite possible !
</p>

<!-- Settings Panel -->
<div id="settings" class="w-full max-w-md bg-white p-4 sm:p-6 rounded-xl shadow-md space-y-6 transition-colors duration-500">

  <!-- Number of Elements -->
  <div>
    <h3 class="font-semibold mb-2 text-sm sm:text-base">Nombre d‚Äô√©l√©ments</h3>
    <div class="flex flex-wrap gap-2">
      <button class="option-btn flex-1 min-w-[60px] py-2 rounded bg-gray-200 text-sm sm:text-base">5</button>
      <button class="option-btn flex-1 min-w-[60px] py-2 rounded bg-gray-200 text-sm sm:text-base">7</button>
      <button class="option-btn flex-1 min-w-[60px] py-2 rounded bg-gray-200 text-sm sm:text-base">10</button>
      <button class="option-btn flex-1 min-w-[60px] py-2 rounded bg-gray-200 text-sm sm:text-base">üé≤ Random</button>
    </div>
  </div>

  <!-- Difficulty -->
  <div>
    <h3 class="font-semibold mb-2 text-sm sm:text-base">Difficult√©</h3>
    <div class="flex flex-wrap gap-2">
      <button class="difficulty-btn flex-1 min-w-[60px] py-2 bg-green-200 text-green-800 rounded text-sm sm:text-base">Facile</button>
      <button class="difficulty-btn flex-1 min-w-[60px] py-2 bg-yellow-200 text-yellow-800 rounded text-sm sm:text-base">Moyen</button>
      <button class="difficulty-btn flex-1 min-w-[60px] py-2 bg-red-200 text-red-800 rounded text-sm sm:text-base">Difficile</button>
    </div>
  </div>

  <!-- Ascending / Descending Toggle -->
  <div class="flex items-center justify-between">
    <span class="text-sm sm:text-base font-semibold">Ordre</span>
    <label class="relative inline-flex items-center cursor-pointer">
      <input type="checkbox" id="orderToggle" class="sr-only peer" checked>
      <div class="w-14 h-7 bg-gray-300 rounded-full peer-checked:bg-blue-500 transition-all duration-300"></div>
      <div class="absolute left-0.5 top-0.5 w-6 h-6 bg-white rounded-full shadow-md transition-all duration-300 peer-checked:translate-x-7"></div>
    </label>
    <span class="ml-2 text-sm sm:text-base" id="orderLabel">Ascendant</span>
  </div>

  <!-- Odd -> Even Sequence Toggle -->
  <div class="flex items-center justify-between mt-3">
    <div>
      <span class="text-sm sm:text-base font-semibold">S√©quence sp√©ciale</span>
      <div class="text-xs text-gray-500">Cliquez d'abord tous les <strong>impairs</strong>, puis les <strong>pairs</strong></div>
    </div>
    <label class="relative inline-flex items-center cursor-pointer">
      <input type="checkbox" id="oddEvenToggle" class="sr-only peer">
      <div class="w-14 h-7 bg-gray-300 rounded-full peer-checked:bg-purple-500 transition-all duration-300"></div>
      <div class="absolute left-0.5 top-0.5 w-6 h-6 bg-white rounded-full shadow-md transition-all duration-300 peer-checked:translate-x-7"></div>
    </label>
  </div>

  <!-- Special sequence mode selector (visible when S√©quence sp√©ciale is active) -->
  <div id="oddEvenModeContainer" class="mt-2 hidden">
    <label class="block text-sm font-semibold mb-1">Mode de s√©quence</label>
    <div class="flex gap-3 items-center text-sm">
      <label class="inline-flex items-center gap-2">
        <input type="radio" name="oddEvenMode" id="oddEvenMode_oddsThenEvens" value="oddsThenEvens" class="sr-only peer">
        <span class="px-3 py-1 rounded-md bg-gray-100 peer-checked:bg-purple-500 peer-checked:text-white">Impairs ‚Üí Pairs</span>
      </label>
      <label class="inline-flex items-center gap-2">
        <input type="radio" name="oddEvenMode" id="oddEvenMode_alternate" value="alternate" class="sr-only peer">
        <span class="px-3 py-1 rounded-md bg-gray-100 peer-checked:bg-purple-500 peer-checked:text-white">Altern√© (impair/pair)</span>
      </label>
    </div>

    <!-- Start parity selector (only meaningful for alternate mode) -->
    <div id="oddEvenStartContainer" class="mt-3 hidden">
      <label class="block text-sm font-semibold mb-1">Commencer par</label>
      <div class="flex gap-3 items-center text-sm">
        <label class="inline-flex items-center gap-2">
          <input type="radio" name="oddEvenStart" id="oddEvenStart_odd" value="odd" class="sr-only peer">
          <span class="px-3 py-1 rounded-md bg-gray-100 peer-checked:bg-teal-500 peer-checked:text-white">Impair</span>
        </label>
        <label class="inline-flex items-center gap-2">
          <input type="radio" name="oddEvenStart" id="oddEvenStart_even" value="even" class="sr-only peer">
          <span class="px-3 py-1 rounded-md bg-gray-100 peer-checked:bg-teal-500 peer-checked:text-white">Pair</span>
        </label>
      </div>
    </div>
  </div>

  <!-- Invert Pairs Order (only meaningful when S√©quence sp√©ciale enabled) -->
  <div id="invertPairsContainer" class="mt-2 hidden">
    <div class="flex items-center justify-between">
      <div>
        <span class="text-sm sm:text-base font-semibold">Ordre des pairs</span>
        <div class="text-xs text-gray-500">Si activ√©, les nombres pairs utilisent l'ordre inverse des impairs.</div>
      </div>
      <label class="relative inline-flex items-center cursor-pointer">
        <input type="checkbox" id="invertPairsToggle" class="sr-only peer">
        <div class="w-14 h-7 bg-gray-300 rounded-full peer-checked:bg-pink-500 transition-all duration-300"></div>
        <div class="absolute left-0.5 top-0.5 w-6 h-6 bg-white rounded-full shadow-md transition-all duration-300 peer-checked:translate-x-7"></div>
      </label>
    </div>
  </div>

  <!-- Theme -->
  <div>
    <h3 class="font-semibold mb-2 text-sm sm:text-base">Th√®me / Couleur</h3>
    <div class="flex flex-wrap gap-2">
      <div class="theme-card flex-1 min-w-[80px] bg-gray-50 text-gray-800 p-3 rounded-lg cursor-pointer text-center text-sm sm:text-base">Light</div>
      <div class="theme-card flex-1 min-w-[80px] bg-gray-900 text-gray-100 p-3 rounded-lg cursor-pointer text-center text-sm sm:text-base">Dark</div>
      <div class="theme-card flex-1 min-w-[80px] bg-gradient-to-r from-purple-400 via-pink-400 to-red-400 text-white p-3 rounded-lg cursor-pointer text-center text-sm sm:text-base">Random</div>
    </div>
  </div>

  <!-- Challenge Mode Toggle -->
  <div class="flex items-center justify-between">
    <span class="text-sm sm:text-base font-semibold">Mode Challenge</span>
    <label class="relative inline-flex items-center cursor-pointer">
      <input type="checkbox" id="challengeMode" class="sr-only peer" checked>
      <div class="w-14 h-7 bg-gray-300 rounded-full peer-checked:bg-red-500 transition-all duration-300"></div>
      <div class="absolute left-0.5 top-0.5 w-6 h-6 bg-white rounded-full shadow-md transition-all duration-300 peer-checked:translate-x-7"></div>
    </label>
  </div>

  <div id="challengeTimeContainer" class="mt-2 hidden">
    <label class="block font-semibold mb-1 text-sm sm:text-base">Temps limite (secondes):</label>
    <input type="number" id="challengeTime" class="w-full border-gray-300 rounded-md p-2 text-sm sm:text-base" value="10" min="5" max="120" />
  </div>

  <!-- Live Timer Toggle -->
  <div class="flex items-center justify-between">
    <span class="text-sm sm:text-base font-semibold">Afficher Timer</span>
    <label class="relative inline-flex items-center cursor-pointer">
      <input type="checkbox" id="showTime" class="sr-only peer" checked>
      <div class="w-14 h-7 bg-gray-300 rounded-full peer-checked:bg-green-500 transition-all duration-300"></div>
      <div class="absolute left-0.5 top-0.5 w-6 h-6 bg-white rounded-full shadow-md transition-all duration-300 peer-checked:translate-x-7"></div>
    </label>
  </div>

  <!-- Sound Toggle -->
  <div class="flex items-center justify-between">
    <span class="text-sm sm:text-base font-semibold">Sons activ√©s</span>
    <label class="relative inline-flex items-center cursor-pointer">
      <input type="checkbox" id="soundToggle" class="sr-only peer" checked>
      <div class="w-14 h-7 bg-gray-300 rounded-full peer-checked:bg-indigo-500 transition-all duration-300"></div>
      <div class="absolute left-0.5 top-0.5 w-6 h-6 bg-white rounded-full shadow-md transition-all duration-300 peer-checked:translate-x-7"></div>
    </label>
  </div>

  <!-- Helper badge toggle -->
  <div class="flex items-center justify-between mt-3">
    <div>
      <span class="text-sm sm:text-base font-semibold">Aide visuelle</span>
      <div class="text-xs text-gray-500">Afficher le badge et surligner le prochain nombre</div>
    </div>
    <label class="relative inline-flex items-center cursor-pointer">
      <input type="checkbox" id="helperToggle" class="sr-only peer">
      <div class="w-14 h-7 bg-gray-300 rounded-full peer-checked:bg-teal-500 transition-all duration-300"></div>
      <div class="absolute left-0.5 top-0.5 w-6 h-6 bg-white rounded-full shadow-md transition-all duration-300 peer-checked:translate-x-7"></div>
    </label>
  </div>

  <button id="start-btn" class="w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg text-sm sm:text-base transition">
    D√©marrer le jeu
  </button>
</div>

<!-- Timer -->
<div id="timer-container" class="hidden mb-4">
  <span class="text-lg font-semibold">‚è± Temps : </span>
  <span id="timer" class="text-2xl font-bold text-blue-600">0.00 s</span>
</div>

<!-- Game Area -->
<div id="numbers" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-3 w-full max-w-md mt-2"></div>

<!-- Message -->
<div id="message" class="text-center text-xl mt-6 font-medium"></div>

<!-- Next expected badge (hidden by default) -->
<div id="next-badge" class="hidden mt-2 text-center">
  <span class="inline-flex items-center px-3 py-1 rounded-full bg-yellow-100 text-yellow-800 font-semibold shadow-sm">Prochain: <strong id="next-number" class="ml-2">0</strong></span>
</div>

<!-- Result Card -->
<div id="result-card" class="hidden mt-6 bg-white shadow-lg rounded-xl p-6 text-center space-y-4 transition-colors duration-500">
  <div class="text-2xl font-bold text-green-600">‚úÖ Bravo !</div>
  <div id="final-time" class="text-3xl font-extrabold text-blue-600">0.00 s</div>
  <div id="score-display" class="text-xl font-semibold text-purple-600"></div>
  <div class="flex flex-wrap justify-center gap-4 mt-4">
    <button id="retry-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg text-sm sm:text-base">üîÅ Rejouer</button>
    <button id="back-btn" class="bg-gray-400 hover:bg-gray-500 text-white font-semibold py-2 px-4 rounded-lg text-sm sm:text-base">‚öôÔ∏è Param√®tres</button>
  </div>
</div>

<!-- Leaderboard -->
<div id="leaderboard" class="hidden mt-6 w-full max-w-md bg-white shadow-lg rounded-xl p-4 text-center">
  <h2 class="text-xl font-bold mb-2">üèÜ Hall of Fame</h2>
  <ol id="leaderboard-list" class="list-decimal space-y-1"></ol>
</div>

<!-- Achievements -->
<div id="achievements" class="hidden mt-4 w-full max-w-md bg-gray-100 shadow-md rounded-xl p-4 text-center">
  <h2 class="text-lg font-semibold mb-2">üéñ Achievements</h2>
  <ul id="achievements-list" class="list-disc space-y-1"></ul>
</div>
 
<!-- Footer -->
<footer class="w-full max-w-md text-center mx-auto mt-6 text-sm text-gray-600">
  <a href="/privacy.html" class="text-blue-600 hover:underline">Politique de confidentialit√©</a>
  <span class="mx-2">‚Ä¢</span>
  <a href="/" class="text-blue-600 hover:underline">Retour</a>
</footer>

<!-- Sounds -->
<audio id="click-sound" src="sounds/click.wav" preload="auto"></audio>
<audio id="success-sound" src="sounds/success.wav"></audio>
<audio id="fail-sound" src="sounds/fail.wav"></audio>

<script>
/* ---------- Refs ---------- */
const numbersContainer = document.getElementById("numbers");
const message = document.getElementById("message");
const startBtn = document.getElementById("start-btn");
const retryBtn = document.getElementById("retry-btn");
const backBtn = document.getElementById("back-btn");
const timerEl = document.getElementById("timer");
const timerBox = document.getElementById("timer-container");
const resultCard = document.getElementById("result-card");
const finalTimeEl = document.getElementById("final-time");
const scoreDisplay = document.getElementById("score-display");
const body = document.getElementById("body");
const settings = document.getElementById("settings");
const instruction = document.querySelector("p");
const orderToggle = document.getElementById("orderToggle");
const orderLabel = document.getElementById("orderLabel");
const oddEvenToggle = document.getElementById("oddEvenToggle");
const invertPairsToggle = document.getElementById("invertPairsToggle");
const clickSound = document.getElementById("click-sound");
const successSound = document.getElementById("success-sound");
const failSound = document.getElementById("fail-sound");
const soundToggle = document.getElementById("soundToggle");
const challengeCheckbox = document.getElementById("challengeMode");
const challengeTimeContainer = document.getElementById("challengeTimeContainer");
const nextBadge = document.getElementById("next-badge");
const nextNumberEl = document.getElementById("next-number");
const helperToggle = document.getElementById("helperToggle");
const oddEvenModeSelect = null; // replaced by radio buttons
const oddEvenModeRadioOdds = document.getElementById('oddEvenMode_oddsThenEvens');
const oddEvenModeRadioAlt = document.getElementById('oddEvenMode_alternate');
const oddEvenStartRadioOdd = document.getElementById('oddEvenStart_odd');
const oddEvenStartRadioEven = document.getElementById('oddEvenStart_even');

/* ---------- State ---------- */
let selectedNum = "random";
let selectedDiff = 100;
let selectedTheme = "light";
let ascendingOrder = true;
let isChallenge = true;
let remainingTime = 0;
let soundEnabled = true;
let oddEvenMode = false;
let invertPairs = false;
let helperEnabled = false;
let oddEvenModeType = 'oddsThenEvens';
let oddEvenStart = 'odd';
let numbers = [], sorted = [], expected = 0, timerInterval = null, startTime = null;

/* ---------- Preferences persistence (single JSON object) ---------- */
function savePrefs(){
  try{
    const prefs = {
      helperEnabled: !!helperEnabled,
      oddEvenMode: !!oddEvenMode,
      invertPairs: !!invertPairs,
      oddEvenModeType: oddEvenModeType || 'oddsThenEvens',
      oddEvenStart: oddEvenStart || 'odd',
      ascendingOrder: !!ascendingOrder,
      selectedTheme: selectedTheme || "light",
      selectedDiff: selectedDiff || 100,
      selectedNum: selectedNum || "7"
    };
    // Prefer shared persistence when available
    if(window.brainSort && typeof window.brainSort.savePrefsObj === 'function'){
      try{ window.brainSort.savePrefsObj(prefs); }catch(e){}
    } else {
      localStorage.setItem('brainSortPrefs', JSON.stringify(prefs));
    }
  }catch(e){ /* ignore storage errors */ }
}

function loadPrefs(){
  try{
    // Try shared prefs loader first
    let prefs = null;
    if(window.brainSort && typeof window.brainSort.loadPrefsObj === 'function'){
      try{ prefs = window.brainSort.loadPrefsObj(); }catch(e){ prefs = null; }
    }
    // Fallback to localStorage if shared loader not available or returned null
    if(!prefs){
      const raw = localStorage.getItem('brainSortPrefs');
      if(!raw) return;
      prefs = JSON.parse(raw);
    }
    if(typeof prefs.helperEnabled !== 'undefined') helperEnabled = !!prefs.helperEnabled;
    if(typeof prefs.oddEvenMode !== 'undefined') oddEvenMode = !!prefs.oddEvenMode;
    if(typeof prefs.invertPairs !== 'undefined') invertPairs = !!prefs.invertPairs;
  if(typeof prefs.oddEvenModeType !== 'undefined') oddEvenModeType = prefs.oddEvenModeType;
  if(typeof prefs.oddEvenStart !== 'undefined') oddEvenStart = prefs.oddEvenStart;
    if(typeof prefs.ascendingOrder !== 'undefined') ascendingOrder = !!prefs.ascendingOrder;
    if(typeof prefs.selectedTheme === 'string') selectedTheme = prefs.selectedTheme;
    if(typeof prefs.selectedDiff !== 'undefined') selectedDiff = prefs.selectedDiff;
    if(typeof prefs.selectedNum === 'string' || typeof prefs.selectedNum === 'number') selectedNum = String(prefs.selectedNum);

    // Apply UI state to controls
    // If shared helper exists, let it apply common prefs to the page (safer)
    if(window.brainSort && typeof window.brainSort.applyCommonPrefsToPage === 'function'){
      try{ window.brainSort.applyCommonPrefsToPage(prefs); }catch(e){}
    } else {
      helperToggle.checked = !!helperEnabled;
      oddEvenToggle.checked = !!oddEvenMode;
      invertPairsToggle.checked = !!invertPairs;
      orderToggle.checked = !!ascendingOrder;
      orderLabel.textContent = ascendingOrder ? "Ascendant" : "Descendant";

      // show/hide invert container
      const invertContainer = document.getElementById("invertPairsContainer");
      if(invertContainer) invertContainer.style.display = oddEvenMode ? "block" : "none";
      // show/hide mode selector
      const modeContainer = document.getElementById("oddEvenModeContainer");
      if(modeContainer) modeContainer.style.display = oddEvenMode ? "block" : "none";
      // set radio states for mode
      if(oddEvenModeRadioOdds) oddEvenModeRadioOdds.checked = (oddEvenModeType === 'oddsThenEvens');
      if(oddEvenModeRadioAlt) oddEvenModeRadioAlt.checked = (oddEvenModeType === 'alternate');
      // show/hide start parity and set its radios
      const startContainer = document.getElementById('oddEvenStartContainer');
      if(startContainer) startContainer.style.display = (oddEvenMode && oddEvenModeType === 'alternate') ? 'block' : 'none';
      if(oddEvenStartRadioOdd) oddEvenStartRadioOdd.checked = (oddEvenStart === 'odd');
      if(oddEvenStartRadioEven) oddEvenStartRadioEven.checked = (oddEvenStart === 'even');

      // restore selected number button styling
      document.querySelectorAll(".option-btn").forEach(b=>b.classList.remove("ring-2","ring-blue-500"));
      const numBtn = Array.from(document.querySelectorAll('.option-btn')).find(b => b.textContent.trim() === selectedNum);
      if(numBtn) numBtn.classList.add("ring-2","ring-blue-500");

      // restore difficulty styling
      document.querySelectorAll(".difficulty-btn").forEach(b=>b.classList.remove("ring-2","ring-blue-500"));
      const diffText = selectedDiff === 50 ? "Facile" : selectedDiff === 100 ? "Moyen" : "Difficile";
      const diffBtn = Array.from(document.querySelectorAll('.difficulty-btn')).find(b => b.textContent.trim() === diffText);
      if(diffBtn) diffBtn.classList.add("ring-2","ring-blue-500");

      // restore theme styling
      document.querySelectorAll(".theme-card").forEach(c=>c.classList.remove("ring-4","ring-blue-500"));
      const themeCard = Array.from(document.querySelectorAll('.theme-card')).find(c => c.textContent.trim().toLowerCase() === selectedTheme);
      if(themeCard) themeCard.classList.add("ring-4","ring-blue-500");
    }

  }catch(e){ /* ignore parse errors */ }
}

/* ---------- Sound toggle ---------- */
soundToggle.addEventListener("change", () => { soundEnabled = soundToggle.checked; });

/* ---------- UI: option buttons ---------- */
document.querySelectorAll(".option-btn").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    document.querySelectorAll(".option-btn").forEach(b=>b.classList.remove("ring-2","ring-blue-500"));
    btn.classList.add("ring-2","ring-blue-500");
    selectedNum = btn.textContent.trim()==="üé≤ Random" ? "random" : btn.textContent.trim();
    savePrefs();
  });
});

document.querySelectorAll(".difficulty-btn").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    document.querySelectorAll(".difficulty-btn").forEach(b=>b.classList.remove("ring-2","ring-blue-500"));
    btn.classList.add("ring-2","ring-blue-500");
    selectedDiff = btn.textContent.trim()==="Facile" ? 50 : btn.textContent.trim()==="Moyen" ? 100 : 999;
    savePrefs();
  });
});

document.querySelectorAll(".theme-card").forEach(card=>{
  card.addEventListener("click", ()=>{
    document.querySelectorAll(".theme-card").forEach(c=>c.classList.remove("ring-4","ring-blue-500"));
    card.classList.add("ring-4","ring-blue-500");
    selectedTheme = card.textContent.trim().toLowerCase();
    applyTheme(selectedTheme);
    savePrefs();
  });
});

/* ---------- Challenge toggle ---------- */
challengeCheckbox.addEventListener("change", ()=> {
  challengeTimeContainer.style.display = challengeCheckbox.checked ? "block" : "none";
});

/* ---------- Order toggle ---------- */
function updateInstruction(){
  if(oddEvenMode){
    const oddOrder = ascendingOrder ? "ascendant" : "descendant";
    const evenOrder = (invertPairs ? !ascendingOrder : ascendingOrder) ? "ascendant" : "descendant";
    if(oddEvenModeType === 'oddsThenEvens'){
      instruction.innerHTML = `Clique sur les nombres <strong>impairs</strong> dans l‚Äôordre ${oddOrder}, puis les <strong>pairs</strong> dans l‚Äôordre ${evenOrder} !`;
    } else {
      instruction.innerHTML = `Clique alternativement <strong>impair</strong> puis <strong>pair</strong> (impair ${oddOrder}, pair ${evenOrder}) !`;
    }
  } else {
    instruction.innerHTML = `Clique sur les nombres <strong>dans l‚Äôordre ${ascendingOrder ? "ascendant" : "descendant"}</strong> le plus vite possible !`;
  }
}

orderToggle.addEventListener("change", ()=>{
  ascendingOrder = orderToggle.checked;
  orderLabel.textContent = ascendingOrder ? "Ascendant" : "Descendant";
  updateInstruction();
  savePrefs();
});

oddEvenToggle.addEventListener("change", ()=>{
  oddEvenMode = oddEvenToggle.checked;
  // show/hide the invert-pairs control when oddEvenMode toggles
  const invertContainer = document.getElementById("invertPairsContainer");
  if(invertContainer) invertContainer.style.display = oddEvenMode ? "block" : "none";
  const modeContainer = document.getElementById("oddEvenModeContainer");
  if(modeContainer) modeContainer.style.display = oddEvenMode ? "block" : "none";
  // show/hide start parity when switching off/on
  const startContainer = document.getElementById('oddEvenStartContainer');
  if(startContainer) startContainer.style.display = (oddEvenMode && oddEvenModeType === 'alternate') ? 'block' : 'none';
  updateInstruction();
  savePrefs();
});

invertPairsToggle.addEventListener("change", ()=>{
  invertPairs = invertPairsToggle.checked;
  updateInstruction();
  savePrefs();
});

// odd/even mode radios
if(oddEvenModeRadioOdds){
  oddEvenModeRadioOdds.addEventListener('change', ()=>{
    if(oddEvenModeRadioOdds.checked){
      oddEvenModeType = 'oddsThenEvens';
      const startContainer = document.getElementById('oddEvenStartContainer');
      if(startContainer) startContainer.style.display = 'none';
      updateInstruction();
      savePrefs();
    }
  });
}
if(oddEvenModeRadioAlt){
  oddEvenModeRadioAlt.addEventListener('change', ()=>{
    if(oddEvenModeRadioAlt.checked){
      oddEvenModeType = 'alternate';
      const startContainer = document.getElementById('oddEvenStartContainer');
      if(startContainer) startContainer.style.display = 'block';
      updateInstruction();
      savePrefs();
    }
  });
}

// start parity radios
if(oddEvenStartRadioOdd){
  oddEvenStartRadioOdd.addEventListener('change', ()=>{
    if(oddEvenStartRadioOdd.checked){ oddEvenStart = 'odd'; savePrefs(); updateInstruction(); }
  });
}
if(oddEvenStartRadioEven){
  oddEvenStartRadioEven.addEventListener('change', ()=>{
    if(oddEvenStartRadioEven.checked){ oddEvenStart = 'even'; savePrefs(); updateInstruction(); }
  });
}

helperToggle.addEventListener("change", ()=>{
  helperEnabled = helperToggle.checked;
  if(!helperEnabled){
    hideNextBadge();
    highlightExpected(false);
  } else {
    // if a game is in progress, show hint for current expected
    if(helperEnabled && expected < sorted.length){
      showNextBadge(sorted[expected]);
      highlightExpected(true);
    }
  }
  savePrefs();
});

/* ---------- Start/retry/back ---------- */
startBtn.addEventListener("click", startGame);
retryBtn.addEventListener("click", startGame);
backBtn.addEventListener("click", ()=>{ resultCard.classList.add("hidden"); settings.style.display="block" });

/* ---------- Game logic ---------- */
function startGame(){
  message.textContent = "";
  numbersContainer.innerHTML = "";
  expected = 0;
  clearInterval(timerInterval); timerInterval = null; startTime = null;
  resultCard.classList.add("hidden");
  settings.style.display = "none";
  applyTheme(selectedTheme);

  // hide next badge and clear highlights at game start
  hideNextBadge();
  highlightExpected(false);

  ascendingOrder = orderToggle.checked;
  isChallenge = challengeCheckbox.checked;
  remainingTime = isChallenge ? parseInt(document.getElementById("challengeTime").value || "30") : 0;
  const showTime = isChallenge || document.getElementById("showTime").checked;
  timerBox.classList.toggle("hidden", !showTime);

  let count = (selectedNum==="random") ? 7 + Math.floor(Math.random()*4) : parseInt(selectedNum) || 7;
  numbers = Array.from({length: count}, ()=> Math.floor(Math.random()*selectedDiff)+1);

  // Build the expected sequence depending on Odd‚ÜíEven mode and ascending/descending
  if(oddEvenMode){
    if(oddEvenModeType === 'oddsThenEvens'){
      // Sort odds and evens separately according to ascendingOrder
      const odds = numbers.filter(n => n % 2 !== 0).sort((a,b)=> ascendingOrder ? a-b : b-a);
      const evensSortAsc = invertPairs ? !ascendingOrder : ascendingOrder;
      const evens = numbers.filter(n => n % 2 === 0).sort((a,b)=> evensSortAsc ? a-b : b-a);
      sorted = odds.concat(evens);
    } else {
      // alternate mode: build odds and evens queues then alternate picks starting with configured parity
      const odds = numbers.filter(n => n % 2 !== 0).sort((a,b)=> ascendingOrder ? a-b : b-a);
      const evensSortAsc = invertPairs ? !ascendingOrder : ascendingOrder;
      const evens = numbers.filter(n => n % 2 === 0).sort((a,b)=> evensSortAsc ? a-b : b-a);
      const result = [];
      let i = 0, j = 0;
      // choose starting side based on oddEvenStart
      let turn = (oddEvenStart === 'even') ? 'even' : 'odd';
      while(i < odds.length || j < evens.length){
        if(turn === 'odd'){
          if(i < odds.length){ result.push(odds[i++]); }
          else if(j < evens.length){ result.push(evens[j++]); }
          turn = 'even';
        } else {
          if(j < evens.length){ result.push(evens[j++]); }
          else if(i < odds.length){ result.push(odds[i++]); }
          turn = 'odd';
        }
      }
      sorted = result;
    }
  } else {
    sorted = [...numbers].sort((a,b)=> ascendingOrder ? a-b : b-a);
  }
  numbers.sort(()=>Math.random()-0.5);

  numbersContainer.style.gridTemplateColumns = "repeat(auto-fit, minmax(60px,1fr))";
  numbers.forEach(num=>{
    const btn = document.createElement("button");
    btn.textContent = num;
    btn.className = "number w-full text-center bg-white border-2 border-blue-500 text-blue-600 rounded-xl py-4 text-2xl font-bold transition active:scale-95 hover:bg-blue-500 hover:text-white shadow-sm";
    btn.addEventListener("click", ()=> checkNumber(btn, num));
    numbersContainer.appendChild(btn);
  });

  // When numbers are rendered, update the next badge for the first expected number
  if(helperEnabled && expected < sorted.length){
    showNextBadge(sorted[expected]);
    highlightExpected(true);
  } else {
    hideNextBadge();
    highlightExpected(false);
  }

  if(showTime){
    if(isChallenge) startChallengeTimer();
    else { startTime = Date.now(); timerInterval = setInterval(updateTimer,100); }
  }
}

function checkNumber(btn,num){
  if (soundEnabled) { clickSound.currentTime = 0; clickSound.play().catch(()=>{}); }
  if(num === sorted[expected]){
    expected++;
    btn.classList.add("invisible");
    // update next badge to the next expected number (if any)
    if(helperEnabled){
      if(expected < sorted.length){
        showNextBadge(sorted[expected]);
        highlightExpected(true);
      } else {
        hideNextBadge();
        highlightExpected(false);
      }
    } else {
      hideNextBadge();
      highlightExpected(false);
    }
    if(expected === sorted.length){
      clearInterval(timerInterval); timerInterval = null;
      if (soundEnabled) successSound.play().catch(()=>{});
      const time = isChallenge ? (parseFloat(document.getElementById("challengeTime").value)-remainingTime).toFixed(2) : ((Date.now()-startTime)/1000).toFixed(2);
      showResult(time);
    }
  } else {
    clearInterval(timerInterval); timerInterval = null;
    if (soundEnabled) failSound.play().catch(()=>{});
    message.innerHTML = '<span class="text-red-600">‚ùå Mauvais ordre ! Red√©marrage...</span>';
    // On failure: show the next expected number as a badge and highlight it
    if(expected < sorted.length){
      showNextBadge(sorted[expected]);
      highlightExpected(true);
    }
    setTimeout(startGame,1200);
  }
}

function showResult(time){
  timerBox.classList.add("hidden");
  numbersContainer.innerHTML = "";
  message.textContent = "";
  const timeSeconds = parseFloat(time);
  finalTimeEl.textContent = `${timeSeconds} s`;

  // calculate score
  const score = calculateScore(timeSeconds, numbers.length, selectedDiff);
  scoreDisplay.textContent = `Score: ${score}`;

  // save & achievements
  saveScore({name:"Player", score, time:timeSeconds, elements:numbers.length, difficulty:selectedDiff, date: new Date()});
  updateAchievements(timeSeconds, selectedDiff);

  resultCard.classList.remove("hidden");

  // show leaderboard & achievements
  showLeaderboard();
  showAchievements();
}

function failGame(){
  if (soundEnabled) failSound.play().catch(()=>{});
  message.innerHTML = '<span class="text-red-600 font-bold">‚è∞ Temps √©coul√© ! Vous avez perdu.</span>';
  numbersContainer.innerHTML = "";
}

/* ---------- Next badge & highlight helpers ---------- */
function showNextBadge(val){
  // Delegate to shared helper if available
  if(window.brainSort && typeof window.brainSort.showNextBadge === 'function'){
    try{ window.brainSort.showNextBadge('next-badge','next-number', val); return; }catch(e){}
  }
  if(!nextBadge || !nextNumberEl) return;
  nextNumberEl.textContent = val;
  nextBadge.classList.remove("hidden");
}

function hideNextBadge(){
  if(window.brainSort && typeof window.brainSort.hideNextBadge === 'function'){
    try{ window.brainSort.hideNextBadge('next-badge'); return; }catch(e){}
  }
  if(!nextBadge) return;
  nextBadge.classList.add("hidden");
}

function highlightExpected(enable){
  // Delegate to shared highlight if available
  if(window.brainSort && typeof window.brainSort.highlightExpected === 'function'){
    try{ window.brainSort.highlightExpected('.number', enable ? expected : -1, sorted); return; }catch(e){}
  }
  const btns = document.querySelectorAll(".number");
  btns.forEach(b=>{
    const n = parseInt(b.textContent,10);
    b.classList.remove("ring-4","ring-yellow-400","animate-pulse");
    if(enable && expected < sorted.length && n === sorted[expected]){
      b.classList.add("ring-4","ring-yellow-400","animate-pulse");
    }
  });
}

/* ---------- Timer helpers ---------- */
function startChallengeTimer(){
  timerEl.textContent = `${remainingTime.toFixed(2)} s`;
  timerInterval = setInterval(()=>{
    remainingTime -= 0.1;
    if(remainingTime <= 0){ remainingTime = 0; clearInterval(timerInterval); failGame(); }
    timerEl.textContent = `${remainingTime.toFixed(2)} s`;
  },100);
}

function updateTimer(){
  if(!startTime) return;
  const elapsed = ((Date.now()-startTime)/1000).toFixed(2);
  timerEl.textContent = `${elapsed} s`;
}

/* ---------- Score & Leaderboard ---------- */
function calculateScore(timeSeconds, numElements, difficulty) {
  // Prefer shared calculation when available
  if(window.brainSort && typeof window.brainSort.calculateScore === 'function'){
    try{ return window.brainSort.calculateScore(timeSeconds, numElements, difficulty); }catch(e){}
  }
  let diffMultiplier = difficulty === 50 ? 1 : difficulty === 100 ? 2 : 3;
  let elementMultiplier = 1 + (numElements - 5) / 5;
  let speedMultiplier = 10 / timeSeconds;
  return Math.round(100 * diffMultiplier * elementMultiplier * speedMultiplier);
}

function saveScore(scoreObj) {
  if(window.brainSort && typeof window.brainSort.saveScore === 'function'){
    try{ window.brainSort.saveScore(scoreObj); return; }catch(e){}
  }
  let leaderboard = JSON.parse(localStorage.getItem("brainSortLeaderboard") || "[]");
  leaderboard.push(scoreObj);
  leaderboard.sort((a,b)=>b.score - a.score);
  leaderboard = leaderboard.slice(0,10);
  localStorage.setItem("brainSortLeaderboard", JSON.stringify(leaderboard));
}

function getLeaderboard() {
  if(window.brainSort && typeof window.brainSort.getLeaderboard === 'function'){
    try{ return window.brainSort.getLeaderboard(); }catch(e){}
  }
  return JSON.parse(localStorage.getItem("brainSortLeaderboard") || "[]");
}

function updateAchievements(time, difficulty) {
  if(window.brainSort && typeof window.brainSort.updateAchievements === 'function'){
    try{ window.brainSort.updateAchievements(time, difficulty); return; }catch(e){}
  }
  let ach = JSON.parse(localStorage.getItem("brainSortAchievements") || "{}");
  if(!ach.firstPerfect) ach.firstPerfect = true;
  ach.fiveUnder10 = ach.fiveUnder10 ? ach.fiveUnder10 + (time <= 10 ? 1 : 0) : (time <= 10 ? 1 : 0);
  if(difficulty === 999) ach.maxDifficulty = true;
  localStorage.setItem("brainSortAchievements", JSON.stringify(ach));
}

function showLeaderboard() {
  if(window.brainSort && typeof window.brainSort.showLeaderboard === 'function'){
    try{ window.brainSort.showLeaderboard('leaderboard-list','leaderboard'); return; }catch(e){}
  }
  const leaderboard = getLeaderboard();
  const list = document.getElementById("leaderboard-list");
  list.innerHTML = "";
  leaderboard.forEach((entry)=>{
    const li = document.createElement("li");
    li.textContent = `${entry.name} - ${entry.score} pts (${entry.time}s, ${entry.elements} √©l√©ments, ${entry.difficulty === 50 ? "Facile" : entry.difficulty === 100 ? "Moyen" : "Difficile"})`;
    list.appendChild(li);
  });
  document.getElementById("leaderboard").classList.remove("hidden");
}

function showAchievements() {
  if(window.brainSort && typeof window.brainSort.showAchievements === 'function'){
    try{ window.brainSort.showAchievements('achievements-list','achievements'); return; }catch(e){}
  }
  const ach = JSON.parse(localStorage.getItem("brainSortAchievements") || "{}");
  const list = document.getElementById("achievements-list");
  list.innerHTML = "";
  if(ach.firstPerfect) list.innerHTML += "<li>üèÖ First perfect round</li>";
  if(ach.fiveUnder10 >= 5) list.innerHTML += "<li>‚è± 5 rounds under 10s</li>";
  if(ach.maxDifficulty) list.innerHTML += "<li>üî• Max difficulty completed</li>";
  document.getElementById("achievements").classList.remove("hidden");
}

/* ---------- Theme handling ---------- */
function applyTheme(mode){
  const panels = document.querySelectorAll("#settings, #challengeTimeContainer, #result-card, #leaderboard, #achievements");
  body.style.backgroundImage = "";
  panels.forEach(p => { p.style.backgroundImage = ""; });
  if(mode === "light"){
    body.style.backgroundColor = "#f9fafb"; body.style.color = "#1f2937";
    panels.forEach(p => { p.style.backgroundColor = "#ffffff"; p.style.color = "#1f2937"; });
  } else if(mode === "dark"){
    body.style.backgroundColor = "#0f172a"; body.style.color = "#f8fafc";
    panels.forEach(p => { p.style.backgroundColor = "#111827"; p.style.color = "#f8fafc"; });
  } else {
    const r = Math.floor(Math.random()*200) + 20;
    const g = Math.floor(Math.random()*200) + 20;
    const b = Math.floor(Math.random()*200) + 20;
    const bg = `rgb(${r},${g},${b})`;
    const brightness = (r*299 + g*587 + b*114)/1000;
    const textColor = brightness > 128 ? "black" : "white";
    body.style.backgroundColor = bg;
    body.style.color = textColor;
    panels.forEach(p=>{ p.style.backgroundColor = `rgba(${r},${g},${b},0.12)`; p.style.color = textColor; });
  }
}

/* ---------- Init ---------- */
document.querySelectorAll(".option-btn").forEach(b=>{ if(b.textContent.trim() === "7"){ b.classList.add("ring-2","ring-blue-500"); selectedNum = "7"; }});
document.querySelectorAll(".difficulty-btn").forEach(b=>{ if(b.textContent.trim() === "Facile"){ b.classList.add("ring-2","ring-blue-500"); selectedDiff = 50; }});
document.querySelectorAll(".theme-card").forEach(c=>{ if(c.textContent.trim().toLowerCase() === "light"){ c.classList.add("ring-4","ring-blue-500"); selectedTheme = "light"; }});

// Load persisted preferences (if any) and update instruction/theme
loadPrefs();
updateInstruction();
applyTheme(selectedTheme);
</script>
</body>
</html>
